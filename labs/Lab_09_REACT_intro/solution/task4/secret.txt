import React, { useState, useContext, createContext } from "react";

const PostContext = createContext();

const Posts = () => {
  const [posts, setPosts] = useState([
    {
      id: 1,
      name: "–ö–æ—Ü—É–ª–µ–≤—Å–∫–∏–π –ò–≥–æ—Ä—å üê∫",
      text: "–ß—Ç–æ –∑–∞ —Ç–∏–≥—Ä —ç—Ç–æ—Ç –ª–µ–≤!",
      img: "https://sun9-73.userapi.com/impg/BbHNryQJpdTQcvIwNU4HqZynQ9rE8EQtVoXEeA/NU6fbXxa8YI.jpg?size=680x453&quality=96&sign=6d09a076046671b45dc23fb1d5626ef4&type=album",
      tags: "–º—É–∑—ã–∫–∞ –æ—Ç–¥—ã—Ö",
      liked: false,
    },
    {
      id: 2,
      name: "–ê–Ω–∞—Å—Ç–∞—Å–∏—è –¶–∞—Ä–µ–≤–∞ üê±",
      text: "–ù–µ —É—Å–ø–µ–≤–∞—é —É—Å–ø–µ–≤–∞—Ç—å ü§∑‚Äç‚ôÄÔ∏è",
      img: "https://sun9-13.userapi.com/impg/9zy-jYg3imTM-_2Os9fwgQ3DtBmPIe-A3zXKrg/6Wzk1I0174I.jpg?size=535x713&quality=96&sign=786c4139f126d8eb9966447db34968cf&type=album",
      tags: "–æ—Ç–¥—ã—Ö",
      liked: false,
    },
    {
      id: 3,
      name: "–í–∏–∫—Ç–æ—Ä –¶–æ–π üé∏üî•",
      text: "–ì—Ä—É–ø–ø–∞ –∫—Ä–æ–≤–∏ ‚Äì –Ω–∞ —Ä—É–∫–∞–≤–µ,\
      \n–ú–æ–π –ø–æ—Ä—è–¥–∫–æ–≤—ã–π –Ω–æ–º–µ—Ä ‚Äì –Ω–∞ —Ä—É–∫–∞–≤–µ,\
      \n–ü–æ–∂–µ–ª–∞–π –º–Ω–µ —É–¥–∞—á–∏ –≤ –±–æ—é,\
      \n–ü–æ–∂–µ–ª–∞–π –º–Ω–µ:\
      \n–ù–µ –æ—Å—Ç–∞—Ç—å—Å—è –≤ —ç—Ç–æ–π —Ç—Ä–∞–≤–µ,\
      \n–ù–µ –æ—Å—Ç–∞—Ç—å—Å—è –≤ —ç—Ç–æ–π —Ç—Ä–∞–≤–µ.\
      \n–ü–æ–∂–µ–ª–∞–π –º–Ω–µ —É–¥–∞—á–∏,\
      \n–ü–æ–∂–µ–ª–∞–π –º–Ω–µ —É–¥–∞—á–∏!",
      img: "https://um.mos.ru/upload/iblock/f6d/07f3e68060d7.jpg",
      tags: "–º—É–∑—ã–∫–∞",
      liked: false,
    },
  ]);

  // –ù–∞–∂–∏—Ç–∏–µ –Ω–∞ –∫–Ω–æ–ø–∫—É –õ–∞–π–∫–∞ –¥–ª—è –ø–æ—Å—Ç–∞
  const handleLike = (id) => {
    setPosts(
      posts.map((post) =>
        post.id === id ? { ...post, liked: !post.liked } : post
      )
    );
  };

  // –°–æ—Å—Ç–æ—è–Ω–∏–µ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –Ω–æ–≤–æ–≥–æ –ø–æ—Å—Ç–∞ —Å –ø—É—Å—Ç—ã–º–∏ –∑–Ω–∞—á–µ–Ω–∏—è–º–∏
  const [newPost, setNewPost] = useState({
    id: null,
    name: "",
    text: "",
    img: "",
    tags: "",
    liked: false,
  });

  // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –ø–æ—Å—Ç–∞ –µ—Å–ª–∏ –µ—Å—Ç—å '–∏–º—è –∏ —Ç–µ–∫—Å—Ç' –∏–ª–∏ '–∏–º—è –∏ –∫–∞—Ä—Ç–∏–Ω–∫–∞'
  const handleAddPost = () => {
    if ((newPost.name && newPost.text) || (newPost.name && newPost.img)) {
      setPosts([...posts, { ...newPost, id: posts.length + 1 }]);
      setNewPost({
        id: null,
        name: "",
        text: "",
        img: "",
        tags: "",
        liked: false,
      });
    }
  };

  // –£–¥–∞–ª–µ–Ω–∏–µ –ø–æ—Å—Ç–∞ –ø–æ –∫–Ω–æ–ø–∫–µ
  const handleDeletePost = (id) => {
    setPosts(posts.filter((post) => post.id !== id));
  };

  // –ü–æ–ª—É—á–∞–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–π —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö —Ç–µ–≥–æ–≤ –∏–∑ –≤—Å–µ—Ö –ø–æ—Å—Ç–æ–≤
  const allTags = [
    ...new Set(
      posts
        // –†–∞–∑–¥–µ–ª–µ–Ω–∏–µ —Å—Ç—Ä–æ–∫–∏ —Ç–µ–≥–æ–≤ –Ω–∞ –æ—Ç–¥–µ–ª—å–Ω—ã–µ —Ç–µ–≥–∏ —Å –ø–æ–º–æ—â—å—é —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—è ','
        .map((post) => post.tags.split(/[ ,]+/))
        // –ü–æ–ª—É—á–∞–µ–º –æ–¥–Ω–æ–º–µ—Ä–Ω—ã–π –º–∞—Å—Å–∏–≤ —Ç–µ–≥–æ–≤
        .flat()
        // –£–±–∏—Ä–∞–µ–º –ø—Ä–æ–±–µ–ª—ã –ø–µ—Ä–µ–¥ –∏ –ø–æ—Å–ª–µ –∫–∞–∂–¥–æ–≥–æ —Ç–µ–≥–∞
        .map((tag) => tag.trim())
        // –£–¥–∞–ª–∏—Ç—å –ø—É—Å—Ç—ã–µ —Ç–µ–≥–∏, –µ—Å–ª–∏ –µ—Å—Ç—å
        .filter((tag) => tag !== "")
        // –î–æ–±–∞–≤–∏—Ç—å "#" –ø–µ—Ä–µ–¥ –∫–∞–∂–¥—ã–º —Ç–µ–≥–æ–º –∏ –ø—Ä–∏–≤–µ—Å—Ç–∏ –≤—Å–µ —Ç–µ–≥–∏ –∫ –Ω–∏–∂–Ω–µ–º—É —Ä–µ–≥–∏—Å—Ç—Ä—É
        .map((tag) => "#" + tag.toLowerCase())
    ),
  ];

  // –°–æ–∑–¥–∞–π—Ç–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö —Ç–µ–≥–æ–≤
  const [selectedTags, setSelectedTags] = useState([]);

  // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∫–ª–∏–∫–∞ –ø–æ —Ç–µ–≥—É
  const handleTagClick = (tag) => {
    if (selectedTags.includes(tag)) {
      setSelectedTags(selectedTags.filter((t) => t !== tag));
    } else {
      setSelectedTags([...selectedTags, tag]);
    }
  };

  return (
    <>
      <PostContext.Provider value={allTags}>
        {/* –í–µ—Å—å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä */}
        <div
          className="container"
          style={{ minWidth: "420px", maxWidth: "500px" }}
        >
          {/* –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –ø–æ—Å—Ç–∞ */}
          <div className="card mb-3 bg-light shadow">
            <div className="card-body">
              <h3 className="card-title mb-3">–ù–æ–≤—ã–π –ø–æ—Å—Ç</h3>
              <div className="mb-3">
                <label htmlFor="name" className="form-label">
                  –ò–º—è
                </label>
                <input
                  type="text"
                  className="form-control"
                  id="name"
                  value={newPost.name}
                  onChange={(e) =>
                    setNewPost({ ...newPost, name: e.target.value })
                  }
                />
              </div>
              <div className="mb-3">
                <label htmlFor="text" className="form-label">
                  –¢–µ–∫—Å—Ç
                </label>
                <textarea
                  className="form-control"
                  id="text"
                  value={newPost.text}
                  onChange={(e) =>
                    setNewPost({ ...newPost, text: e.target.value })
                  }
                />
              </div>
              <div className="mb-3">
                <label htmlFor="img" className="form-label">
                  –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ (c—Å—ã–ª–∫–∞ –Ω–∞ —Ñ–æ—Ç–æ)
                </label>
                <input
                  type="text"
                  className="form-control"
                  id="img"
                  value={newPost.img}
                  onChange={(e) =>
                    setNewPost({ ...newPost, img: e.target.value })
                  }
                />
              </div>
              <div className="mb-3">
                <label htmlFor="tags" className="form-label">
                  –¢–µ–≥
                </label>
                <input
                  type="text"
                  className="form-control"
                  id="tags"
                  value={newPost.tags}
                  onChange={(e) =>
                    setNewPost({ ...newPost, tags: e.target.value })
                  }
                />
              </div>
              <button
                className="btn btn-primary bg-gradient"
                onClick={handleAddPost}
              >
                –î–æ–±–∞–≤–∏—Ç—å –ø–æ—Å—Ç
              </button>
            </div>
          </div>
          {/* –ó–∞–≥–æ–ª–æ–≤–æ–∫ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –µ—Å—Ç—å –ª–∏ –ù–æ–≤–æ—Å—Ç–∏ */}
          <h1>
            <span
              className={
                "badge mt-5 mb-3 shadow  bg-gradient bg-" +
                (posts.length > 0 ? "primary" : "danger")
              }
            >
              {posts.length > 0 ? "–ù–æ–≤–æ—Å—Ç–∏" : "–ù–æ–≤–æ—Å—Ç–µ–π –Ω–µ—Ç"}
            </span>
          </h1>
          {/* –í—ã–≤–æ–¥ –≤—Å–µ—Ö —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö —Ç–µ–≥–æ–≤ —Å–æ –≤—Å–µ—Ö –ø–æ—Å—Ç–æ–≤ */}
          <div>
            {allTags.map((tag) => (
              <button
                key={tag}
                className={`btn p-2 m-2 bg-gradient shadow-sm ${
                  selectedTags.includes(tag)
                    ? "bg-warning"
                    : "bg-primary-subtle"
                }`}
                onClick={() => handleTagClick(tag)}
              >
                {tag}
              </button>
            ))}
            {/* –°–±—Ä–æ—Å –Ω–∞–∂–∞—Ç–∏—è –∫–Ω–æ–ø–æ–∫ —Ç–µ–≥–æ–≤ */}
            {posts.length > 0 && (
              <button
                className="btn p-2 m-2 bg-gradient shadow-sm btn-danger"
                onClick={() => setSelectedTags([])}
              >
                –û—á–∏—Å—Ç–∏—Ç—å —Ç–µ–≥–∏
              </button>
            )}
          </div>
          {/* –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤—Å–µ—Ö –ø–æ—Å—Ç–æ–≤ */}
          {posts
            .filter(
              (post) =>
                selectedTags.length === 0 ||
                selectedTags.every((tag) =>
                  post.tags.toLowerCase().split(/[ ,]+/).includes(tag.substr(1))
                )
            )
            .map((post) => (
              <div key={post.id} className="card mb-3 bg-light shadow">
                <div className="card-body">
                  <h3 className="card-title mb-3">
                    {post.name}{" "}
                    {post.tags && `#${post.tags.split(/[ ,]+/).join(" #")}`}
                  </h3>
                  {post.img && (
                    <img
                      src={post.img}
                      className="card-img mb-2 shadow"
                      style={{ width: "360px", height: "auto" }}
                      alt="image"
                    />
                  )}
                  <p className="card-text" style={{ whiteSpace: "pre-wrap" }}>
                    {post.text}
                  </p>
                  <button
                    className={
                      "btn rounded-pill btn-" +
                      (post.liked ? "danger " : "outline-primary")
                    }
                    onClick={() => handleLike(post.id)}
                  >
                    {post.liked ? (
                      <i class="bi bi-suit-heart-fill"></i>
                    ) : (
                      <i class="bi bi-suit-heart"></i>
                    )}
                  </button>
                  <button
                    className="btn btn-outline-danger mx-5 rounded-pill position-relative"
                    onClick={() => handleDeletePost(post.id)}
                  >
                    <i class="bi bi-person-x-fill"></i>
                  </button>
                </div>
              </div>
            ))}
        </div>
      </PostContext.Provider>
    </>
  );
};

const App = () => {
  return <Posts />;
};

export default App;
